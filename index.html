<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Meta tag para impedir indexação por sites de busca -->
    <meta name="robots" content="noindex, nofollow">
    <title>Acompanhamento de Localizador de Veículos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Pica.js para imagens -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pica/9.0.1/pica.min.js"></script>
    <!-- jsPDF para relatórios em PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --bg-color: #0f172a; --card-color: #1e293b; --text-color: #f1f5f9; --text-muted-color: #94a3b8; --border-color: #334155; --primary-color: #3b82f6; --primary-hover: #2563eb; --input-bg: #334155;
        }
        html.light {
            --bg-color: #f1f5f9; --card-color: #ffffff; --text-color: #1e293b; --text-muted-color: #64748b; --border-color: #e2e8f0; --primary-color: #2563eb; --primary-hover: #1d4ed8; --input-bg: #f1f5f9;
        }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; font-size: 16px; }
        .tab-button { transition: all 0.3s ease; border-bottom: 4px solid transparent; color: var(--text-muted-color); }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .custom-modal { background-color: rgba(0, 0, 0, 0.7); }
        .toast { animation: slide-in 0.5s forwards, slide-out 0.5s 4.5s forwards; }
        @keyframes slide-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slide-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
        #cameraPreview { transform: scaleX(-1); }
        .options-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 2.5rem;
            z-index: 10;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
        }
        .options-menu.show {
            display: block;
        }
        .restore-option {
            border: 2px solid var(--border-color);
            transition: all 0.2s ease-in-out;
        }
        .restore-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-color);
        }
        .help-icon-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .help-tooltip {
            visibility: hidden;
            width: 220px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: normal;
        }
        .help-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent;
        }
        .help-icon-wrapper:hover .help-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            border: 1px solid var(--text-muted-color);
            color: var(--text-muted-color);
            margin-left: 0.5rem;
            cursor: help;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Container Principal -->
    <div class="container mx-auto max-w-4xl p-4">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold flex items-center justify-center gap-3" style="color: var(--primary-color);"><i class="ph-bold ph-car"></i>Localizador</h1>
            <p style="color: var(--text-muted-color);">O seu companheiro para localizar veículos!</p>
        </header>

        <nav class="flex justify-around mb-6" style="border-bottom: 2px solid var(--border-color);">
            <button data-tab="search" class="tab-button active w-full py-4 text-lg font-semibold flex items-center justify-center gap-2"><i class="ph-bold ph-magnifying-glass text-2xl"></i> Consultar</button>
            <button data-tab="list" class="tab-button w-full py-4 text-lg font-semibold flex items-center justify-center gap-2"><i class="ph-bold ph-list-bullets text-2xl"></i> Casos</button>
            <button data-tab="settings" class="tab-button w-full py-4 text-lg font-semibold flex items-center justify-center gap-2"><i class="ph-bold ph-gear text-2xl"></i> Ajustes</button>
        </nav>

        <main>
            <div id="tab-search" class="tab-content active space-y-6">
                <div class="p-6 rounded-lg shadow-lg" style="background-color: var(--card-color);">
                    <label for="plateInput" class="text-xl font-bold mb-4 flex items-center">
                        Consultar Matrícula
                        <span class="help-icon-wrapper">
                            <i class="ph-bold ph-question help-icon"></i>
                            <span class="help-tooltip">Digite a matrícula completa ou parcial para encontrar casos.</span>
                        </span>
                    </label>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="plateInput" placeholder="Digite a matrícula do veículo" class="w-full border rounded-md px-4 py-3 focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border-color: var(--border-color); focus-ring-color: var(--primary-color);">
                        <button id="searchPlateBtn" class="text-white font-bold py-3 px-8 rounded-md flex items-center justify-center gap-2" style="background-color: var(--primary-color); hover-background-color: var(--primary-hover);"><i class="ph-bold ph-search"></i> Procurar</button>
                    </div>
                </div>
                <div id="caseResult" class="hidden space-y-4"></div>
            </div>

            <div id="tab-list" class="tab-content space-y-6">
                <div class="p-6 rounded-lg shadow-lg" style="background-color: var(--card-color);">
                    <h2 class="text-xl font-bold mb-4">Filtrar e Ordenar Casos</h2>
                     <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4" id="filtersContainer">
                             <!-- Selects de filtro serão populados por JS -->
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 pt-4 border-t" style="border-color: var(--border-color);">
                            <div class="lg:col-span-2">
                                <label for="filter-modelo" class="block text-sm font-medium mb-1">Modelo</label>
                                <input type="text" id="filter-modelo" placeholder="Digite parte do modelo..." class="w-full border rounded-md py-2 px-3 focus:outline-none" style="background-color:var(--input-bg); border-color:var(--border-color);">
                            </div>
                            <div class="flex items-end">
                                <button id="resetFiltersBtn" class="w-full text-white font-bold py-2 px-4 rounded-md flex items-center justify-center gap-2" style="background-color: var(--primary-color);">
                                    <i class="ph-bold ph-arrow-counter-clockwise"></i> Redefinir Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="caseList" class="space-y-4"></div>
                <div class="text-center mt-4"><button id="loadMoreBtn" class="hidden font-bold py-3 px-8 rounded-md" style="background-color: var(--card-color); border: 2px solid var(--border-color);">Carregar Mais</button></div>
            </div>

            <div id="tab-settings" class="tab-content space-y-6">
                 <div class="p-6 rounded-lg shadow-lg" style="background-color: var(--card-color);">
                    <h2 class="text-xl font-bold mb-2">Dados e Relatórios</h2>
                    <p class="mb-4" style="color: var(--text-muted-color);">Exporte os seus dados ou visualize os logs de utilização.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="exportListPdfBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><i class="ph-bold ph-list-dashes"></i> Lista de Casos</button>
                        <button id="exportPdfBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><i class="ph-bold ph-file-pdf"></i> PDF Completo</button>
                        <button id="exportCsvBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><i class="ph-bold ph-file-csv"></i> Excel (Visitas)</button>
                    </div>
                     <button id="showLogsBtn" class="mt-4 w-full font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg" style="background-color: var(--card-color); border: 2px solid var(--border-color);"><i class="ph-bold ph-file-text"></i> Ver Logs de Utilização</button>
                </div>
                
                <div class="p-6 rounded-lg shadow-lg" style="background-color: var(--card-color);">
                    <h2 class="text-xl font-bold mb-2">Aparência</h2>
                    <div class="flex items-center justify-between"><label for="theme-toggle" class="text-lg">Tema da Aplicação</label><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="theme-toggle" class="sr-only peer"><div class="w-14 h-8 bg-gray-400 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div></label></div>
                </div>
                
                <div class="p-6 rounded-lg shadow-lg" style="background-color: var(--card-color);">
                    <h2 class="text-xl font-bold mb-2 flex items-center">
                        Backup e Restauro 
                        <span class="help-icon-wrapper">
                            <i class="ph-bold ph-question help-icon"></i>
                            <span class="help-tooltip">Faça um backup para segurança ou para mover dados. O restauro oferece as opções de "Mesclar" (adicionar/atualizar) ou "Sobrescrever" (apagar tudo e substituir).</span>
                        </span>
                    </h2>
                    <p class="mb-4" style="color: var(--text-muted-color);">Guarde ou recupere todos os seus dados.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="backupBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><i class="ph-bold ph-download-simple"></i> Fazer Backup</button>
                        <button id="restoreBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><i class="ph-bold ph-upload-simple"></i> Restaurar</button>
                    </div>
                </div>
                <div class="p-6 rounded-lg shadow-lg" style="background-color: var(--card-color);">
                    <h2 class="text-xl font-bold mb-2 flex items-center">
                        Analisar e Guardar Dados 
                        <span class="help-icon-wrapper">
                            <i class="ph-bold ph-question help-icon"></i>
                            <span class="help-tooltip">Cole o texto completo do sistema. A app irá extrair os dados e criar um novo caso ou atualizar um já existente, usando o número do contrato para evitar duplicidade.</span>
                        </span>
                    </h2>
                    <p class="mb-4" style="color: var(--text-muted-color);">Cole o texto do sistema para registar ou atualizar um caso.</p>
                    <textarea id="dataInput" rows="10" class="w-full border rounded-md px-4 py-2 focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border-color: var(--border-color);" placeholder="Cole o texto completo do caso aqui..."></textarea>
                    <button id="parseAndSaveBtn" class="mt-4 w-full text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg" style="background-color: var(--primary-color);"><i class="ph-bold ph-text-aa"></i> Analisar e Guardar</button>
                </div>
                <!-- Zona de Perigo -->
                <div class="p-6 rounded-lg shadow-lg border border-red-500/50" style="background-color: var(--card-color);">
                    <h2 class="text-xl font-bold mb-2 flex items-center text-red-400">
                        Zona de Perigo
                    </h2>
                    <p class="mb-4" style="color: var(--text-muted-color);">Ações nesta secção são permanentes e não podem ser desfeitas.</p>
                    <button id="resetAppBtn" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><i class="ph-bold ph-warning"></i> Limpar Tudo</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modais e Overlays -->
    <div id="loadingModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center"><div class="p-8 rounded-lg text-center shadow-2xl" style="background-color: var(--card-color);"><div class="animate-spin rounded-full h-16 w-16 border-t-4 mx-auto" style="border-top-color: var(--primary-color);"></div><p class="mt-4 text-xl font-semibold" id="loadingText">A processar...</p></div></div>
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    <div id="logsModal" class="hidden fixed inset-0 custom-modal z-40 flex items-center justify-center p-4"><div class="rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col" style="background-color: var(--card-color);"><div class="p-4 flex justify-between items-center" style="border-bottom: 1px solid var(--border-color);"><h3 class="text-xl font-bold">Logs de Atividade</h3><button id="closeLogsBtn"><i class="ph-fill ph-x-circle text-3xl" style="color: var(--text-muted-color);"></i></button></div><div id="logsContent" class="p-4 overflow-y-auto"></div></div></div>
    <div id="cameraModal" class="hidden fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"><video id="cameraPreview" class="w-full h-full object-cover" autoplay playsinline></video><button id="capturePhotoBtn" class="absolute bottom-10 bg-white rounded-full w-20 h-20 p-1 border-4 focus:outline-none" style="border-color: var(--text-muted-color);"></button><button id="closeCameraBtn" class="absolute top-5 right-5 text-white bg-black bg-opacity-50 rounded-full p-2"><i class="ph-fill ph-x-circle text-4xl"></i></button></div>
    <div id="photoViewModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4"><div class="rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col relative" style="background-color: var(--card-color);"><button id="closePhotoViewBtn" class="absolute -top-3 -right-3 text-white bg-red-600 rounded-full p-1 z-10"><i class="ph-fill ph-x-circle text-3xl"></i></button><img id="photoViewImage" src="" alt="Foto do Avistamento" class="w-full h-full object-contain rounded-lg"></div></div>
    <div id="confirmationModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4"><div class="p-6 rounded-lg shadow-xl max-w-sm w-full" style="background-color: var(--card-color);"><h3 id="confirmationTitle" class="text-xl font-bold mb-4">Confirmar Ação</h3><p id="confirmationMessage" class="mb-6" style="color: var(--text-muted-color);">Tem a certeza?</p><div class="flex justify-end gap-4"><button id="confirmCancelBtn" class="px-6 py-2 rounded-lg" style="background-color: var(--border-color);">Cancelar</button><button id="confirmOkBtn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Confirmar</button></div></div></div>
    <div id="resetConfirmModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4">
        <div class="p-6 rounded-lg shadow-xl max-w-sm w-full" style="background-color: var(--card-color);">
            <h3 class="text-xl font-bold mb-4 text-red-400">Apagar Todos os Dados</h3>
            <p class="mb-4" style="color: var(--text-muted-color);">Esta ação é irreversível. Todos os casos, visitas e configurações serão apagados permanentemente.</p>
            <p class="mb-4" style="color: var(--text-muted-color);">Para confirmar, digite <strong>CONFIRMO</strong> no campo abaixo.</p>
            <input type="text" id="resetConfirmInput" class="w-full border rounded-md px-4 py-2 focus:outline-none" style="background-color: var(--input-bg); border-color: var(--border-color);" placeholder="Digite CONFIRMO">
            <div class="flex justify-end gap-4 mt-6">
                <button id="resetCancelBtn" class="px-6 py-2 rounded-lg" style="background-color: var(--border-color);">Cancelar</button>
                <button id="resetConfirmOkBtn" class="px-6 py-2 bg-red-800 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Confirmar e Apagar Tudo</button>
            </div>
        </div>
    </div>
    <div id="editCaseModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4">
        <div class="p-6 rounded-lg shadow-xl max-w-2xl w-full flex flex-col max-h-[90vh]" style="background-color: var(--card-color);">
            <h3 class="text-xl font-bold mb-4 flex-shrink-0">Editar Caso</h3>
            <form id="editCaseForm" class="space-y-4 overflow-y-auto pr-2">
                <!-- Contract Info -->
                <h4 class="text-lg font-semibold" style="color:var(--primary-color);">Informações do Contrato</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="edit-cliente" class="block text-sm font-medium">Cliente</label><input type="text" id="edit-cliente" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div><label for="edit-cpf" class="block text-sm font-medium">CPF</label><input type="text" id="edit-cpf" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div><label for="edit-telefone" class="block text-sm font-medium">Telefone</label><input type="text" id="edit-telefone" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div><label for="edit-contrato" class="block text-sm font-medium">Contrato</label><input type="text" id="edit-contrato" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);" readonly></div>
                    <div><label for="edit-atrasoDesde" class="block text-sm font-medium">Atraso Desde</label><input type="text" id="edit-atrasoDesde" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div><label for="edit-notificacao" class="block text-sm font-medium">Notificação</label><input type="text" id="edit-notificacao" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                </div>
                 <!-- Warranty Info -->
                <h4 class="text-lg font-semibold pt-4" style="color:var(--primary-color);">Dados da Garantia</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="edit-placa" class="block text-sm font-medium">Matrícula</label><input type="text" id="edit-placa" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);" readonly></div>
                    <div><label for="edit-marca" class="block text-sm font-medium">Marca</label><input type="text" id="edit-marca" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div><label for="edit-modelo" class="block text-sm font-medium">Modelo</label><input type="text" id="edit-modelo" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div><label for="edit-ano" class="block text-sm font-medium">Ano</label><input type="text" id="edit-ano" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div><label for="edit-cor" class="block text-sm font-medium">Cor</label><input type="text" id="edit-cor" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div><label for="edit-renavam" class="block text-sm font-medium">Renavam</label><input type="text" id="edit-renavam" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div class="sm:col-span-2"><label for="edit-chassi" class="block text-sm font-medium">Chassi</label><input type="text" id="edit-chassi" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                    <div class="sm:col-span-2"><label for="edit-valorFIPE" class="block text-sm font-medium">Valor FIPE</label><input type="text" id="edit-valorFIPE" class="mt-1 w-full border rounded-md py-2 px-3" style="background-color:var(--input-bg); border-color:var(--border-color);"></div>
                </div>
            </form>
            <div class="flex justify-end gap-4 mt-6 flex-shrink-0">
                <button id="editCaseCancelBtn" class="px-6 py-2 rounded-lg" style="background-color: var(--border-color);">Cancelar</button>
                <button id="editCaseSaveBtn" class="px-6 py-2 text-white rounded-lg" style="background-color: var(--primary-color);">Guardar Alterações</button>
            </div>
        </div>
    </div>
    <div id="addressModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4">
        <div class="p-6 rounded-lg shadow-xl max-w-md w-full flex flex-col max-h-[90vh]" style="background-color: var(--card-color);">
            <h3 id="addressModalTitle" class="text-xl font-bold mb-4 flex-shrink-0">Adicionar Morada(s)</h3>
            <div class="space-y-4 overflow-y-auto pr-2">
                <div>
                    <label class="block text-sm font-medium mb-1" style="color: var(--text-muted-color);">Cole o texto da(s) morada(s):</label>
                    <textarea id="addressTextInput" rows="8" class="w-full border rounded-md px-4 py-2" style="background-color: var(--input-bg); border-color: var(--border-color);" placeholder="Pode colar múltiplas moradas. O sistema irá tentar separá-las."></textarea>
                </div>
                 <div id="gps-button-container" class="text-center" style="color: var(--text-muted-color);">OU</div>
                 <button id="useCurrentLocationBtn" class="w-full font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg" style="background-color: var(--card-color); border: 2px solid var(--border-color);"><i class="ph-bold ph-map-pin"></i> Usar Localização Atual</button>
            </div>
            <div class="flex justify-end gap-4 mt-6 flex-shrink-0">
                <button id="addressCancelBtn" class="px-6 py-2 rounded-lg" style="background-color: var(--border-color);">Cancelar</button>
                <button id="addressParseAndSaveBtn" class="px-6 py-2 text-white rounded-lg" style="background-color: var(--primary-color);">Analisar e Guardar</button>
            </div>
        </div>
    </div>
    <div id="addressPreviewModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4">
        <div class="p-6 rounded-lg shadow-xl max-w-2xl w-full flex flex-col max-h-[90vh]" style="background-color: var(--card-color);">
            <h3 class="text-xl font-bold mb-4 flex-shrink-0">Confirme as Moradas Encontradas</h3>
            <div id="addressPreviewContent" class="space-y-3 overflow-y-auto pr-2"></div>
            <div class="flex justify-end gap-4 mt-6 flex-shrink-0">
                <button id="addressPreviewCancelBtn" class="px-6 py-2 rounded-lg" style="background-color: var(--border-color);">Cancelar</button>
                <button id="addressPreviewConfirmBtn" class="px-6 py-2 text-white rounded-lg" style="background-color: var(--primary-color);">Confirmar e Guardar</button>
            </div>
        </div>
    </div>
    <div id="observationModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4"><div class="p-6 rounded-lg shadow-xl max-w-md w-full" style="background-color: var(--card-color);"><h3 class="text-xl font-bold mb-4">Adicionar Observação Geral</h3><div><textarea id="observationTextInput" rows="5" class="w-full border rounded-md px-4 py-2" style="background-color: var(--input-bg); border-color: var(--border-color);" placeholder="Digite a sua anotação sobre o caso..."></textarea></div><div class="flex justify-end gap-4 mt-6"><button id="observationCancelBtn" class="px-6 py-2 rounded-lg" style="background-color: var(--border-color);">Cancelar</button><button id="observationSaveBtn" class="px-6 py-2 text-white rounded-lg" style="background-color: var(--primary-color);">Guardar</button></div></div></div>
    <div id="imageSourceModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4"><div class="p-6 rounded-lg shadow-xl max-w-sm w-full" style="background-color: var(--card-color);"><h3 class="text-xl font-bold mb-4">Adicionar Imagem</h3><p class="mb-6" style="color: var(--text-muted-color);">Escolha a origem da imagem para a visita.</p><div class="space-y-4"><button id="takePictureBtn" class="w-full font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg" style="background-color: var(--primary-color);"><i class="ph-bold ph-camera"></i> Tirar Foto</button><button id="chooseGalleryBtn" class="w-full font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg" style="background-color: var(--card-color); border: 2px solid var(--border-color);"><i class="ph-bold ph-image"></i> Escolher da Galeria</button></div><div class="flex justify-end mt-6"><button id="imageSourceCancelBtn" class="px-6 py-2 rounded-lg" style="background-color: var(--border-color);">Cancelar</button></div></div></div>
    <div id="restoreStrategyModal" class="hidden fixed inset-0 custom-modal z-50 flex items-center justify-center p-4"><div class="p-6 rounded-lg shadow-xl max-w-md w-full" style="background-color: var(--card-color);"><h3 class="text-xl font-bold mb-4">Restaurar Backup</h3><p class="mb-6" style="color: var(--text-muted-color);">Escolha como importar os dados do ficheiro.</p><div class="space-y-4"><button data-strategy="merge" class="restore-option w-full text-left p-4 rounded-lg"><strong class="block">Mesclar</strong><span class="text-sm">Adiciona novos dados e atualiza existentes. Preserva os dados atuais.</span></button><button data-strategy="overwrite" class="restore-option w-full text-left p-4 rounded-lg"><strong class="block">Sobrescrever</strong><span class="text-sm text-red-400">APAGA TUDO e substitui pelos dados do backup. Use com cuidado.</span></button></div><div class="flex justify-end gap-4 mt-6"><button id="restoreCancelBtn" class="px-6 py-2 rounded-lg" style="background-color: var(--border-color);">Cancelar</button><button id="restoreConfirmBtn" class="px-6 py-2 text-white rounded-lg disabled:opacity-50" style="background-color: var(--primary-color);" disabled>Confirmar</button></div></div></div>
    <input type="file" id="imageUploadInput" class="hidden" accept="image/*">
    <input type="file" id="restoreFileInput" class="hidden" accept=".json">

    <script>
        (function() {
            // =================================================================================
            // APP INITIALIZATION & CONFIG
            // =================================================================================
            const App = {};

            App.config = { 
                dbName: 'VehicleLocatorDB', 
                dbVersion: 4, 
                resultsPerPage: 5 
            };
            
            const STORE_CASES = 'cases';
            const STORE_SIGHTINGS = 'sightings';
            const STORE_ADDRESSES = 'addresses';
            const STORE_OBSERVATIONS = 'observations';
            const STORE_LOGS = 'logs';
            const STORE_BACKUPS = 'backups';

            App.ui = {
                themeToggle: document.getElementById('theme-toggle'),
                tabs: document.querySelectorAll('.tab-button'),
                tabContents: document.querySelectorAll('.tab-content'),
                plateInput: document.getElementById('plateInput'),
                searchPlateBtn: document.getElementById('searchPlateBtn'),
                caseResult: document.getElementById('caseResult'),
                caseList: document.getElementById('caseList'),
                loadMoreBtn: document.getElementById('loadMoreBtn'),
                filtersContainer: document.getElementById('filtersContainer'),
                filterModelo: document.getElementById('filter-modelo'),
                resetFiltersBtn: document.getElementById('resetFiltersBtn'),
                sortOrder: document.getElementById('sort-order'),
                settings: {
                    backupBtn: document.getElementById('backupBtn'),
                    restoreBtn: document.getElementById('restoreBtn'),
                    restoreFileInput: document.getElementById('restoreFileInput'),
                    dataInput: document.getElementById('dataInput'),
                    parseAndSaveBtn: document.getElementById('parseAndSaveBtn'),
                    showLogsBtn: document.getElementById('showLogsBtn'),
                    exportPdfBtn: document.getElementById('exportPdfBtn'),
                    exportCsvBtn: document.getElementById('exportCsvBtn'),
                    exportListPdfBtn: document.getElementById('exportListPdfBtn'),
                    resetAppBtn: document.getElementById('resetAppBtn'),
                },
                modals: {
                    loading: document.getElementById('loadingModal'), loadingText: document.getElementById('loadingText'),
                    toastContainer: document.getElementById('toastContainer'),
                    logs: document.getElementById('logsModal'), logsContent: document.getElementById('logsContent'), closeLogsBtn: document.getElementById('closeLogsBtn'),
                    camera: document.getElementById('cameraModal'), cameraPreview: document.getElementById('cameraPreview'), capturePhotoBtn: document.getElementById('capturePhotoBtn'), closeCameraBtn: document.getElementById('closeCameraBtn'),
                    photoView: document.getElementById('photoViewModal'), photoViewImage: document.getElementById('photoViewImage'), closePhotoViewBtn: document.getElementById('closePhotoViewBtn'),
                    confirmation: document.getElementById('confirmationModal'), confirmationTitle: document.getElementById('confirmationTitle'), confirmationMessage: document.getElementById('confirmationMessage'), confirmOkBtn: document.getElementById('confirmOkBtn'), confirmCancelBtn: document.getElementById('confirmCancelBtn'),
                    resetConfirm: document.getElementById('resetConfirmModal'), resetConfirmInput: document.getElementById('resetConfirmInput'), resetConfirmOkBtn: document.getElementById('resetConfirmOkBtn'), resetCancelBtn: document.getElementById('resetCancelBtn'),
                    editCase: document.getElementById('editCaseModal'), editCaseForm: document.getElementById('editCaseForm'), editCaseSaveBtn: document.getElementById('editCaseSaveBtn'), editCaseCancelBtn: document.getElementById('editCaseCancelBtn'),
                    address: document.getElementById('addressModal'), addressModalTitle: document.getElementById('addressModalTitle'), addressTextInput: document.getElementById('addressTextInput'), addressObsInput: document.getElementById('addressObsInput'), useCurrentLocationBtn: document.getElementById('useCurrentLocationBtn'), addressParseAndSaveBtn: document.getElementById('addressParseAndSaveBtn'), addressCancelBtn: document.getElementById('addressCancelBtn'),
                    addressPreview: document.getElementById('addressPreviewModal'), addressPreviewContent: document.getElementById('addressPreviewContent'), addressPreviewConfirmBtn: document.getElementById('addressPreviewConfirmBtn'), addressPreviewCancelBtn: document.getElementById('addressPreviewCancelBtn'),
                    observation: document.getElementById('observationModal'), observationTextInput: document.getElementById('observationTextInput'), observationSaveBtn: document.getElementById('observationSaveBtn'), observationCancelBtn: document.getElementById('observationCancelBtn'),
                    restoreStrategy: document.getElementById('restoreStrategyModal'), restoreConfirmBtn: document.getElementById('restoreConfirmBtn'), restoreCancelBtn: document.getElementById('restoreCancelBtn'),
                    imageSource: document.getElementById('imageSourceModal'), takePictureBtn: document.getElementById('takePictureBtn'), chooseGalleryBtn: document.getElementById('chooseGalleryBtn'), imageSourceCancelBtn: document.getElementById('imageSourceCancelBtn'),
                },
                imageUploadInput: document.getElementById('imageUploadInput'),
            };
            
            App.state = { 
                currentPage: 1, 
                currentPlate: null, 
                cameraStream: null, 
                editingAddressId: null,
                parsedAddresses: [],
                filterState: {
                    status: 'aberto',
                    marca: '',
                    ano: '',
                    cor: '',
                    modelo: '',
                    sort: 'placa'
                }
            };
            
            // =================================================================================
            // THEME MANAGER
            // =================================================================================
            App.ThemeManager = {
                init() {
                    const savedTheme = localStorage.getItem('theme');
                    const systemPrefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
                    this.apply(savedTheme || (systemPrefersLight ? 'light' : 'dark'));
                    App.ui.themeToggle.addEventListener('change', () => this.apply(App.ui.themeToggle.checked ? 'light' : 'dark'));
                },
                apply(theme) {
                    document.documentElement.classList.toggle('light', theme === 'light');
                    App.ui.themeToggle.checked = theme === 'light';
                    localStorage.setItem('theme', theme);
                }
            };
            
            // =================================================================================
            // DATABASE MANAGER (IndexedDB)
            // =================================================================================
            App.DBManager = {
                db: null,
                async open() {
                    return new Promise((resolve, reject) => {
                        if (this.db) return resolve(this.db);
                        const request = indexedDB.open(App.config.dbName, App.config.dbVersion);
                        request.onerror = (e) => reject("Erro DB: " + e.target.errorCode);
                        request.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
                        request.onupgradeneeded = (e) => {
                            const db = e.target.result;
                            const setupStore = (name, keyPath, indexes = []) => {
                                if (!db.objectStoreNames.contains(name)) {
                                    const store = db.createObjectStore(name, { keyPath, autoIncrement: keyPath === 'id' });
                                    indexes.forEach(index => store.createIndex(index, index, { unique: false }));
                                }
                            };
                            setupStore(STORE_CASES, 'placaNormalizada');
                            setupStore(STORE_SIGHTINGS, 'id', ['placaNormalizada']);
                            setupStore(STORE_ADDRESSES, 'id', ['placaNormalizada']);
                            setupStore(STORE_OBSERVATIONS, 'id', ['placaNormalizada']);
                            setupStore(STORE_LOGS, 'id');
                            setupStore(STORE_BACKUPS, 'timestamp');
                        };
                    });
                },
                async transaction(stores, type, cb) {
                    const t = (await this.open()).transaction(stores, type);
                    return new Promise((res, rej) => { t.oncomplete = res; t.onerror = () => rej(t.error); cb(Array.isArray(stores) ? stores.map(s => t.objectStore(s)) : t.objectStore(stores)); });
                },
                get: (store, key) => new Promise(r => { if(!key) { r(null); return; } App.DBManager.transaction(store, 'readonly', s => s.get(key).onsuccess = e => r(e.target.result))}),
                getAll: (store) => new Promise(r => App.DBManager.transaction(store, 'readonly', s => s.getAll().onsuccess = e => r(e.target.result))),
                getFromIndex: (store, idx, q) => new Promise(r => App.DBManager.transaction(store, 'readonly', s => s.index(idx).getAll(q).onsuccess = e => r(e.target.result))),
                put: (store, item) => App.DBManager.transaction(store, 'readwrite', s => s.put(item)),
                delete: (store, key) => App.DBManager.transaction(store, 'readwrite', s => s.delete(key)),
            };
            
            // =================================================================================
            // UI MANAGER (Rendering and Interactions)
            // =================================================================================
            App.UIManager = {
                init() {
                    App.ui.tabs.forEach(tab => tab.addEventListener('click', () => this.switchTab(tab.dataset.tab)));
                    App.ui.caseResult.addEventListener('click', (e) => {
                        const btn = e.target.closest('button');
                        if (btn) {
                            if (btn.classList.contains('add-address-btn')) App.AddressManager.showAddressModal({ plate: btn.dataset.plate });
                            else if (btn.classList.contains('add-observation-btn')) App.ObservationManager.showObservationModal(btn.dataset.plate);
                            else if (btn.classList.contains('add-sighting-btn')) this.showImageSourceModal(btn.dataset.plate);
                            else if (btn.classList.contains('delete-case-btn')) App.CaseManager.deleteCase(btn.dataset.plate);
                            else if (btn.classList.contains('export-case-pdf-btn')) App.DataManager.exportSingleCasePDF(btn.dataset.plate);
                            else if (btn.classList.contains('edit-case-btn')) App.CaseManager.showEditModal(btn.dataset.plate);
                            else if (btn.classList.contains('toggle-options-btn')) { e.stopPropagation(); this.toggleOptionsMenu(btn); }
                            else if (btn.classList.contains('edit-address-btn')) App.AddressManager.showAddressModal({ plate: btn.dataset.plate, addressId: parseInt(btn.dataset.addressId) });
                            else if (btn.classList.contains('delete-address-btn')) App.AddressManager.deleteAddress(parseInt(btn.dataset.addressId), btn.dataset.plate);
                        }

                        const li = e.target.closest('li');
                        if (li) {
                             if (e.target.closest('.view-photo-btn')) this.showPhoto(parseInt(li.dataset.sightingId));
                             if (e.target.closest('.delete-sighting-btn')) App.CaseManager.deleteSighting(parseInt(li.dataset.sightingId), li.dataset.plate);
                             if (e.target.closest('.navigate-btn')) App.AddressManager.navigate(parseInt(li.dataset.addressId));
                             if (e.target.closest('.delete-observation-btn')) App.ObservationManager.deleteObservation(parseInt(li.dataset.observationId), li.dataset.plate);
                        }

                        const switchInput = e.target.closest('.toggle-status-switch');
                         if(switchInput && e.target.tagName === 'INPUT') {
                            App.CaseManager.toggleCaseStatus(switchInput.dataset.plate, e.target);
                        }

                    });
                    App.ui.caseList.addEventListener('click', e => {
                        const card = e.target.closest('.case-card');
                        if (!card) return;
                        if (e.target.closest('.case-card-main')) { this.switchTab('search'); App.ui.plateInput.value = card.dataset.plateValue; App.CaseManager.search(card.dataset.plateValue); }
                    });
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.options-menu-container')) {
                            document.querySelectorAll('.options-menu.show').forEach(menu => menu.classList.remove('show'));
                        }
                    });
                },
                toggleOptionsMenu(button) {
                    const menu = button.nextElementSibling;
                    const isShowing = menu.classList.contains('show');
                    document.querySelectorAll('.options-menu.show').forEach(m => m.classList.remove('show'));
                    if (!isShowing) menu.classList.add('show');
                },
                switchTab(tabId) {
                    App.ui.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
                    App.ui.tabContents.forEach(c => c.classList.toggle('active', c.id === `tab-${tabId}`));
                    if (tabId === 'list') App.CaseManager.renderList();
                },
                showLoading: (text) => { App.ui.modals.loadingText.textContent = text; App.ui.modals.loading.classList.remove('hidden'); },
                hideLoading: () => App.ui.modals.loading.classList.add('hidden'),
                showToast(message, type = 'info') { const c = {info:'bg-blue-500',success:'bg-green-500',error:'bg-red-500'}, i = {info:'ph-info',success:'ph-check-circle',error:'ph-x-circle'}; const t=document.createElement('div'); t.className=`toast text-white p-4 rounded-lg shadow-lg flex items-center gap-3 ${c[type]}`; t.innerHTML=`<i class="ph-bold ${i[type]} text-2xl"></i><span>${message}</span>`; App.ui.modals.toastContainer.appendChild(t); setTimeout(()=>t.remove(),5e3) },
                async showCamera() { try { if(!(await App.PermissionsManager.requestCamera())) return; App.state.cameraStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); App.ui.modals.cameraPreview.srcObject = App.state.cameraStream; App.ui.modals.camera.classList.remove('hidden'); } catch (err){this.showToast('Não foi possível aceder à câmara.','error')} },
                hideCamera() { if(App.state.cameraStream) App.state.cameraStream.getTracks().forEach(t=>t.stop()); App.ui.modals.camera.classList.add('hidden'); },
                capturePhoto() { const c=document.createElement('canvas');c.width=App.ui.modals.cameraPreview.videoWidth;c.height=App.ui.modals.cameraPreview.videoHeight;const x=c.getContext('2d');x.translate(c.width,0);x.scale(-1,1);x.drawImage(App.ui.modals.cameraPreview,0,0,c.width,c.height);c.toBlob(b=>this._saveSighting(b),'image/jpeg',0.9); this.hideCamera(); },
                async showPhoto(id) { const s = await App.DBManager.get(STORE_SIGHTINGS,id); if(s?.photo){const u=URL.createObjectURL(s.photo);App.ui.modals.photoViewImage.src=u;App.ui.modals.photoView.classList.remove('hidden');App.ui.modals.photoViewImage.onload=()=>URL.revokeObjectURL(u)}else this.showToast('Foto não encontrada.','error')},
                hidePhoto:() => { App.ui.modals.photoView.classList.add('hidden'); App.ui.modals.photoViewImage.src=""; },
                showConfirmation(title, message) { return new Promise(r => { App.ui.modals.confirmationTitle.textContent=title;App.ui.modals.confirmationMessage.textContent=message;App.ui.modals.confirmation.classList.remove('hidden');const c=res=>{App.ui.modals.confirmation.classList.add('hidden');r(res)};App.ui.modals.confirmOkBtn.onclick=()=>c(true);App.ui.modals.confirmCancelBtn.onclick=()=>c(false);}) },
                showImageSourceModal(plate) { App.state.currentPlate = plate; App.ui.modals.imageSource.classList.remove('hidden'); },
                hideImageSourceModal() { App.ui.modals.imageSource.classList.add('hidden'); },
                async _saveSighting(imageBlob) {
                    this.showLoading('Redimensionando e guardando...');
                    try {
                        if (!(await App.PermissionsManager.requestLocation())) return App.UIManager.showToast('Permissão de localização é necessária.', 'error');
                        const picaInstance = pica();
                        const offscreenCanvas = document.createElement('canvas');
                        const img = await createImageBitmap(imageBlob);

                        let targetWidth = 640; let targetHeight = 480;
                        if (img.width > img.height) { targetHeight = (img.height / img.width) * targetWidth; } else { targetWidth = (img.width / img.height) * targetHeight; }
                        offscreenCanvas.width = targetWidth; offscreenCanvas.height = targetHeight;
                        
                        const resizedCanvas = await picaInstance.resize(img, offscreenCanvas);
                        const resizedBlob = await picaInstance.toBlob(resizedCanvas, 'image/jpeg', 0.8);
                        
                        const sightingData = { 
                            placaNormalizada: App.state.currentPlate, 
                            timestamp: new Date(), 
                            location: await App.PermissionsManager.getLocation(), 
                            photo: resizedBlob 
                        };
                        await App.DBManager.put(STORE_SIGHTINGS, sightingData);
                        this.showToast('Visita registada!', 'success');
                        if (document.getElementById('tab-search').classList.contains('active') && App.ui.plateInput.value) App.CaseManager.search(App.ui.plateInput.value);
                    } catch(e) {
                        this.showToast(`Erro ao guardar visita: ${e.message}`, 'error');
                    } finally {
                        this.hideLoading();
                    }
                },
                showRestoreStrategyModal() {
                    return new Promise(resolve => {
                        const modal = App.ui.modals.restoreStrategy;
                        const confirmBtn = App.ui.modals.restoreConfirmBtn;
                        let selectedStrategy = null;

                        modal.classList.remove('hidden');
                        confirmBtn.disabled = true;

                        const options = modal.querySelectorAll('.restore-option');
                        options.forEach(opt => {
                            opt.onclick = () => {
                                options.forEach(o => o.classList.remove('selected'));
                                opt.classList.add('selected');
                                selectedStrategy = opt.dataset.strategy;
                                confirmBtn.disabled = false;
                            };
                        });
                        
                        const close = (strategy) => {
                             modal.classList.add('hidden');
                             options.forEach(o => o.classList.remove('selected'));
                             resolve(strategy);
                        };

                        App.ui.modals.restoreConfirmBtn.onclick = () => close(selectedStrategy);
                        App.ui.modals.restoreCancelBtn.onclick = () => close(null);
                    });
                }
            };
            
            // =================================================================================
            // PERMISSIONS MANAGER
            // =================================================================================
            App.PermissionsManager = {
                async request(name, queryFn, showAlert = true) {
                     const k=`permission_${name}_status`; 
                     if(localStorage.getItem(k) === 'denied') {
                         if (showAlert) App.UIManager.showToast(`A permissão de ${name} foi negada anteriormente.`, 'error');
                         return false;
                     }
                    try {
                        await queryFn();
                        localStorage.setItem(k,'granted');
                        return true;
                    } catch (err) {
                        if (showAlert) App.UIManager.showToast(`Permissão de ${name} negada.`, 'error');
                        localStorage.setItem(k,'denied');
                        return false;
                    }
                },
                requestInitialPermissions() {
                    const asked = localStorage.getItem('initial_permissions_asked');
                    if (!asked) {
                        setTimeout(() => {
                           this.request('câmara', () => navigator.mediaDevices.getUserMedia({video:true}).then(s=>s.getTracks().forEach(t=>t.stop())), false);
                           this.request('localização', () => new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true})), false);
                           localStorage.setItem('initial_permissions_asked', 'true');
                        }, 2000);
                    }
                },
                requestCamera: (showAlert = true) => App.PermissionsManager.request('câmara', () => navigator.mediaDevices.getUserMedia({video:true}).then(s=>s.getTracks().forEach(t=>t.stop())), showAlert),
                requestLocation: (showAlert = true) => App.PermissionsManager.request('localização', () => new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true})), showAlert),
                async getLocation() { 
                    if(!(await this.requestLocation())) return null;
                    return new Promise(r=>navigator.geolocation.getCurrentPosition(p=>r({lat:p.coords.latitude,lon:p.coords.longitude}),()=>r(null)));
                }
            };
            
            App.PlateManager = { normalize: plate => plate ? plate.toUpperCase().replace(/[^A-Z0-9]/g, '') : '' };

            // =================================================================================
            // ADDRESS MANAGER
            // =================================================================================
            App.AddressManager = {
                async showAddressModal({plate, addressId = null}) { 
                    App.state.currentPlate = plate; 
                    App.state.editingAddressId = addressId;
                    
                    App.ui.modals.addressModalTitle.textContent = addressId ? "Editar Morada" : "Adicionar Morada(s)";
                    App.ui.modals.addressTextInput.value = '';
                    App.ui.modals.addressObsInput.value = '';
                    App.ui.modals.useCurrentLocationBtn.style.display = addressId ? 'none' : 'flex';
                    document.getElementById('gps-button-container').style.display = addressId ? 'none' : 'block';
                    
                    if (addressId) {
                        const addr = await App.DBManager.get(STORE_ADDRESSES, addressId);
                        App.ui.modals.addressTextInput.value = addr.tipo === 'GPS' ? '' : this.formatForEdit(addr);
                        App.ui.modals.addressObsInput.value = addr.observacoes || '';
                    }
                    
                    App.ui.modals.address.classList.remove('hidden'); 
                },
                hideAddressModal:()=>App.ui.modals.address.classList.add('hidden'),
                async handleParseAndSave() {
                    App.UIManager.hideAddressModal();
                    const text = App.ui.modals.addressTextInput.value;
                    const obs = App.ui.modals.addressObsInput.value;
                    if (!text) return App.UIManager.showToast('O campo de morada está vazio.', 'error');
                    
                    App.UIManager.showLoading("A analisar moradas...");
                    const parsedAddresses = App.AddressParser.parseBlock(text);
                    App.UIManager.hideLoading();

                    if (parsedAddresses.length === 0) {
                        return App.UIManager.showToast('Nenhuma morada válida encontrada no texto.', 'error');
                    }

                    // Add observations to all parsed addresses if provided
                    if(obs) {
                        parsedAddresses.forEach(addr => addr.observacoes = obs);
                    }
                    
                    App.state.parsedAddresses = parsedAddresses;
                    this.showAddressPreview(parsedAddresses);
                },
                showAddressPreview(parsedList) {
                    const contentEl = App.ui.modals.addressPreviewContent;
                    contentEl.innerHTML = '';
                    parsedList.forEach((addr, index) => {
                        contentEl.innerHTML += `
                            <div class="p-3 rounded-lg" style="background-color: var(--input-bg);">
                                <p class="font-bold">Morada ${index + 1}:</p>
                                <p class="text-sm">${this.format(addr)}</p>
                            </div>
                        `;
                    });
                    App.ui.modals.addressPreview.classList.remove('hidden');
                },
                hideAddressPreview() {
                     App.ui.modals.addressPreview.classList.add('hidden');
                },
                async confirmAndSaveAddresses() {
                    App.UIManager.showLoading("A guardar moradas...");
                    for (const addr of App.state.parsedAddresses) {
                        addr.placaNormalizada = App.state.currentPlate;
                        await App.DBManager.put(STORE_ADDRESSES, addr);
                    }
                    this.hideAddressPreview();
                    App.UIManager.showToast(`${App.state.parsedAddresses.length} morada(s) guardada(s)!`, 'success');
                    App.CaseManager.search(App.state.currentPlate);
                },

                async saveFromGPS() {
                    const obs = App.ui.modals.addressObsInput.value;
                    const loc=await App.PermissionsManager.getLocation();
                    if(!loc) return;
                    await App.DBManager.put(STORE_ADDRESSES,{tipo:'GPS',latitude:loc.lat,longitude:loc.lon,observacoes:obs,placaNormalizada:App.state.currentPlate});
                    this.hideAddressModal();
                    App.UIManager.showToast('Morada GPS guardada!', 'success');
                    App.CaseManager.search(App.state.currentPlate);
                },
                formatForEdit(addr) { return `${addr.logradouro||''}, ${addr.numero||'S/N'}, ${addr.bairro||''}, ${addr.cidade||''}, ${addr.estado||''}, ${addr.cep||''}`; },
                format(addr) { let b=(addr.tipo==='GPS')?`📍 GPS (${addr.latitude.toFixed(4)}, ${addr.longitude.toFixed(4)})`:`🏠 ${addr.logradouro||''}, ${addr.numero||'S/N'} - ${addr.bairro||''}, ${addr.cidade||''}/${addr.estado||''}`;if(addr.observacoes)b+=`<br><span class="text-xs italic" style="color:var(--text-muted-color);"><i class="ph-bold ph-chat-text"></i> ${addr.observacoes}</span>`;return b},
                formatForPdf(addr) { let b=(addr.tipo==='GPS')?`GPS: (${addr.latitude.toFixed(4)},${addr.longitude.toFixed(4)})`:`Morada: ${addr.logradouro||''}, ${addr.numero||'S/N'} - ${addr.bairro||''}, ${addr.cidade||''}/${addr.estado||''}`;if(addr.observacoes)b+=`\nObs: ${addr.observacoes}`;return b},
                async navigate(id) { const a=await App.DBManager.get(STORE_ADDRESSES,id);if(!a)return;const q=a.tipo==='GPS'?`${a.latitude},${a.longitude}`:`${a.logradouro}, ${a.numero}, ${a.cidade}, ${a.estado}`;window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`,'_blank')},
                async deleteAddress(id,p) { if(await App.UIManager.showConfirmation('Excluir Morada','Deseja apagar esta morada?')){await App.DBManager.delete(STORE_ADDRESSES,id);App.UIManager.showToast('Morada excluída.','success');App.CaseManager.search(p)}}
            };
            
            // =================================================================================
            // ADDRESS PARSER
            // =================================================================================
            App.AddressParser = {
                parseBlock(text) {
                    const addressBlocks = text.split(/(?=Residencial|Comercial|Outros)/i);
                    const parsedAddresses = [];

                    for (const block of addressBlocks) {
                        if (block.trim() === '') continue;
                        
                        let formattedBlock = block.replace(/([a-z])([A-Z])/g, '$1 $2');
                        formattedBlock = formattedBlock.replace(/UFCEP/g, 'UF CEP');

                        const addr = this.parseSingle(formattedBlock);
                        if(addr.logradouro || addr.cidade || addr.cep) {
                             parsedAddresses.push(addr);
                        }
                    }
                    return parsedAddresses;
                },

                parseSingle(text) {
                    const R = (txt, regex) => { 
                        const match = txt.match(regex); 
                        return match ? match[1].trim() : null; 
                    };
                    text = ` ${text.replace(/[.,]/g, ' ')} `;
                    const addr = {};

                    addr.tipo = R(text, /(Residencial|Comercial|Outros)/i);
                    addr.cep = R(text, /CEP\s?(\d{8}|\d{5}-\d{3})/i);
                    addr.estado = R(text, /\b(AC|AL|AP|AM|BA|CE|DF|ES|GO|MA|MT|MS|MG|PA|PB|PR|PE|PI|RJ|RN|RS|RO|RR|SC|SP|SE|TO)\b/i);

                    const cityMatch = text.match(/\b(Cuiaba|Sinop|Alta Floresta)\b/i);
                    addr.cidade = cityMatch ? cityMatch[0] : null;

                    const numMatch = text.match(/(?:Numero|Num|N[º°]?)\s*(\d+)/i) || text.match(/\b\d+\b/);
                    addr.numero = numMatch ? numMatch[0].replace(/\D/g, '') : null;
                    
                    const bairroMatch = text.match(/(?:Bairro|Setor|St|Jd|Jardim)\s*([\w\s]+?)(?=,|$|\d{5}-\d{3})/i);
                    addr.bairro = bairroMatch ? bairroMatch[1].trim() : null;

                    addr.logradouro = text.replace(/(Residencial|Comercial|Outros|Rua|Av|Avenida|Est|Estrada|Numero|Num|N[º°]?|CEP)/gi, '')
                                        .replace(addr.cep || '', '')
                                        .replace(addr.numero || '', '')
                                        .replace(addr.bairro || '', '')
                                        .replace(addr.cidade || '', '')
                                        .replace(addr.estado || '', '')
                                        .replace(/\s+/g, ' ').trim();
                    return addr;
                }
            };
            
            // =================================================================================
            // OBSERVATION MANAGER
            // =================================================================================
            App.ObservationManager = {
                showObservationModal(plate) { App.state.currentPlate=plate; App.ui.modals.observationTextInput.value=''; App.ui.modals.observation.classList.remove('hidden'); },
                hideObservationModal:()=>App.ui.modals.observation.classList.add('hidden'),
                async saveObservation() { const t=App.ui.modals.observationTextInput.value;if(!t)return App.UIManager.showToast('A observação está vazia.','error');await App.DBManager.put(STORE_OBSERVATIONS,{placaNormalizada:App.state.currentPlate,text:t,timestamp:new Date()});App.UIManager.showToast('Observação guardada!','success');this.hideObservationModal();App.CaseManager.search(App.state.currentPlate);},
                async deleteObservation(id,p) { if(await App.UIManager.showConfirmation('Excluir Observação','Deseja apagar esta anotação?')){await App.DBManager.delete(STORE_OBSERVATIONS,id);App.UIManager.showToast('Observação excluída.','success');App.CaseManager.search(p)}}
            };

            // =================================================================================
            // CASE MANAGER (Core App Logic)
            // =================================================================================
            App.CaseManager = {
                async search(plate) {
                    App.UIManager.showLoading('A procurar...');
                    const allCases = await App.DBManager.getAll(STORE_CASES);
                    const normalizedPlate = App.PlateManager.normalize(plate);
                    const results = allCases.filter(c => c.placaNormalizada.includes(normalizedPlate));

                    App.UIManager.hideLoading();
                    
                    if (results.length > 0) {
                        if (results.length === 1) {
                            const caseData = results[0];
                            const [sightings, addresses, observations] = await Promise.all([ App.DBManager.getFromIndex(STORE_SIGHTINGS, 'placaNormalizada', caseData.placaNormalizada), App.DBManager.getFromIndex(STORE_ADDRESSES, 'placaNormalizada', caseData.placaNormalizada), App.DBManager.getFromIndex(STORE_OBSERVATIONS, 'placaNormalizada', caseData.placaNormalizada) ]);
                            this.renderCaseDetails(caseData, sightings, addresses, observations);
                        } else {
                           this.renderSearchResultsList(results, plate);
                        }
                    } else { 
                        App.ui.caseResult.innerHTML = `<div class="p-4 rounded-lg text-center" style="background-color: var(--card-color);">Nenhum caso para a busca <strong>"${plate}"</strong>.</div>`; 
                    }
                    App.ui.caseResult.classList.remove('hidden');
                },
                renderSearchResultsList(results, searchTerm) {
                    let html = `<div class="p-6 rounded-lg shadow-lg" style="background-color: var(--card-color);"><h3 class="text-xl font-bold mb-4">Resultados para "${searchTerm}"</h3><ul class="space-y-3">`;
                    results.forEach(caseData => {
                        html += `
                           <li class="p-3 rounded-lg flex justify-between items-center" style="background-color: var(--input-bg);">
                               <div>
                                   <p class="font-bold text-lg">${caseData.garantia.placa}</p>
                                   <p class="text-sm" style="color:var(--text-muted-color);">${caseData.garantia.marca} ${caseData.garantia.modelo}</p>
                               </div>
                               <button class="view-details-from-list text-white font-bold py-2 px-4 rounded-md" style="background-color:var(--primary-color);" data-plate="${caseData.garantia.placa}">Ver Detalhes</button>
                           </li>
                        `;
                    });
                    html += `</ul></div>`;
                    App.ui.caseResult.innerHTML = html;

                     App.ui.caseResult.querySelectorAll('.view-details-from-list').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const plate = e.target.dataset.plate;
                            App.ui.plateInput.value = plate;
                            App.CaseManager.search(plate); 
                        });
                    });
                },
                renderCaseDetails(caseData, sightings, addresses, observations) {
                    const detailItem = (label, value) => `<p><strong class="font-semibold">${label}:</strong> ${value || 'N/A'}</p>`;
                    const contractDetails = [
                        {label: 'Cliente', value: caseData.cliente},
                        {label: 'CPF', value: caseData.cpf},
                        {label: 'Telefone', value: caseData.telefone},
                        {label: 'Contrato', value: caseData.contrato},
                        {label: 'Atraso Desde', value: caseData.atrasoDesde},
                        {label: 'Notificação', value: caseData.notificacao},
                    ].map(item => (item.value && item.value !== 'N/A') ? detailItem(item.label, item.value) : '').join('');

                    const warrantyDetails = Object.entries(caseData.garantia).map(([k,v]) => detailItem(k.charAt(0).toUpperCase()+k.slice(1),v)).join('');
                    
                    const sightingsHtml = sightings.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map(s=>`<li data-sighting-id="${s.id}" data-plate="${s.placaNormalizada}" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-md gap-2" style="background-color: var(--input-bg);"><div class="flex-grow text-sm"><p><i class="ph-bold ph-calendar"></i> ${new Date(s.timestamp).toLocaleString('pt-BR')}</p>${s.location?`<p><i class="ph-bold ph-map-pin"></i> Lat: ${s.location.lat.toFixed(4)}, Lon: ${s.location.lon.toFixed(4)}</p>`:''}</div><div class="flex items-center gap-4 mt-2 sm:mt-0">${s.photo?`<button title="Ver Foto" class="view-photo-btn text-orange-400"><i class="ph-fill ph-camera text-3xl"></i></button>`:`<div class="w-[36px]"></div>`}<button title="Excluir Visita" class="delete-sighting-btn text-red-500"><i class="ph-fill ph-trash text-3xl"></i></button></div></li>`).join('')||`<li class="p-3">Nenhuma visita registada.</li>`;
                    const addressesHtml = addresses.map(a=>`<li data-address-id="${a.id}" data-plate="${a.placaNormalizada}" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-md gap-2 relative" style="background-color: var(--input-bg);"><div class="flex-grow text-sm">${App.AddressManager.format(a)}</div><div class="flex items-center gap-2 mt-2 sm:mt-0"><button title="Navegar" class="navigate-btn text-green-500 p-2"><i class="ph-fill ph-navigation-arrow text-3xl"></i></button><div class="relative options-menu-container"><button title="Mais Opções" class="toggle-options-btn p-2" style="color:var(--text-muted-color);"><i class="ph-fill ph-dots-three-vertical text-3xl"></i></button><div class="options-menu"><button data-address-id="${a.id}" data-plate="${a.placaNormalizada}" class="edit-address-btn w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center gap-2">Editar</button><button data-address-id="${a.id}" data-plate="${a.placaNormalizada}" class="delete-address-btn w-full text-left px-4 py-2 text-red-500 hover:bg-gray-700 flex items-center gap-2">Excluir</button></div></div></div></li>`).join('')||`<li class="p-3">Nenhuma morada registada.</li>`;
                    const observationsHtml = observations.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map(o=>`<li data-observation-id="${o.id}" data-plate="${o.placaNormalizada}" class="flex justify-between items-start p-3 rounded-md gap-2" style="background-color: var(--input-bg);"><div class="flex-grow text-sm"><p class="font-semibold" style="color: var(--text-muted-color);">${new Date(o.timestamp).toLocaleString('pt-BR')}</p><p>${o.text}</p></div><button title="Excluir Observação" class="delete-observation-btn text-red-500 flex-shrink-0"><i class="ph-fill ph-trash text-3xl"></i></button></li>`).join('')||`<li class="p-3">Nenhuma observação geral.</li>`;
                    
                    const caseStatus = caseData.status || 'aberto';
                    
                    App.ui.caseResult.innerHTML = `<div class="p-6 rounded-lg shadow-lg space-y-6" style="background-color: var(--card-color);">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold" style="color:var(--primary-color);">${caseData.garantia.placa}</h3>
                                <p class="text-lg" style="color:var(--text-muted-color);">${caseData.garantia.marca} ${caseData.garantia.modelo}</p>
                            </div>
                            <div class="relative options-menu-container">
                                <button title="Opções do Caso" class="toggle-options-btn p-2 rounded-full hover:bg-slate-700"><i class="ph-fill ph-list text-3xl"></i></button>
                                <div class="options-menu w-48">
                                    <button data-plate="${caseData.placaNormalizada}" class="edit-case-btn w-full text-left px-4 py-2 hover:bg-slate-700 flex items-center gap-2"><i class="ph-bold ph-pencil-simple"></i> Editar Caso</button>
                                    <button data-plate="${caseData.placaNormalizada}" class="export-case-pdf-btn w-full text-left px-4 py-2 hover:bg-slate-700 flex items-center gap-2"><i class="ph-bold ph-file-pdf"></i> Exportar PDF</button>
                                    <button data-plate="${caseData.placaNormalizada}" class="delete-case-btn w-full text-left px-4 py-2 text-red-400 hover:bg-slate-700 flex items-center gap-2"><i class="ph-bold ph-trash"></i> Excluir Caso</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pb-2" style="border-bottom: 2px solid var(--border-color);">
                            <h4 class="text-xl font-bold" style="color:var(--primary-color);">Status do Caso</h4>
                            <div class="flex items-center gap-4">
                                <span class="text-lg font-semibold ${caseStatus === 'aberto' ? 'text-green-400' : 'text-yellow-400'}">${caseStatus === 'aberto' ? 'Aberto' : 'Encerrado'}</span>
                                <label class="relative inline-flex items-center cursor-pointer toggle-status-switch" data-plate="${caseData.placaNormalizada}">
                                    <input type="checkbox" class="sr-only peer" ${caseStatus === 'encerrado' ? 'checked' : ''}>
                                    <div class="w-14 h-8 bg-gray-400 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600"></div>
                                </label>
                            </div>
                        </div>

                        <div><h3 class="text-xl font-bold pb-2 mb-3" style="color:var(--primary-color); border-bottom: 2px solid var(--border-color);">Informações do Contrato</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">${contractDetails}</div></div>
                        <div><h3 class="text-xl font-bold pb-2 mb-3" style="color:var(--primary-color); border-bottom: 2px solid var(--border-color);">Dados da Garantia</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">${warrantyDetails}</div></div>
                        <div><div class="flex justify-between items-center pb-2 mb-3" style="border-bottom: 2px solid var(--border-color);"><h3 class="text-xl font-bold" style="color:var(--primary-color);">Observações Gerais</h3><button data-plate="${caseData.placaNormalizada}" class="add-observation-btn text-white font-bold py-1 px-3 rounded-md flex items-center gap-1 text-sm" style="background-color: var(--primary-color);"><i class="ph-bold ph-plus"></i> Adicionar</button></div><ul class="space-y-2">${observationsHtml}</ul></div>
                        <div><div class="flex justify-between items-center pb-2 mb-3" style="border-bottom: 2px solid var(--border-color);"><h3 class="text-xl font-bold" style="color:var(--primary-color);">Moradas</h3><button data-plate="${caseData.placaNormalizada}" class="add-address-btn text-white font-bold py-1 px-3 rounded-md flex items-center gap-1 text-sm" style="background-color: var(--primary-color);"><i class="ph-bold ph-plus"></i> Adicionar</button></div><ul class="space-y-2">${addressesHtml}</ul></div>
                        <div><div class="flex justify-between items-center pb-2 mb-3" style="border-bottom: 2px solid var(--border-color);"><h3 class="text-xl font-bold" style="color:var(--primary-color);">Visitas e Avistamentos</h3><button data-plate="${caseData.placaNormalizada}" class="add-sighting-btn text-white font-bold py-1 px-3 rounded-md flex items-center gap-1 text-sm" style="background-color: var(--primary-color);"><i class="ph-bold ph-camera"></i> Adicionar</button></div><ul class="space-y-2">${sightingsHtml}</ul></div>
                    </div>`;
                    App.ui.caseResult.classList.remove('hidden');
                },
                async showEditModal(plate) {
                    const caseData = await App.DBManager.get(STORE_CASES, plate);
                    if (!caseData) return App.UIManager.showToast('Caso não encontrado para edição.', 'error');
                    
                    App.state.currentPlate = plate;
                    const form = App.ui.modals.editCaseForm;
                    form.querySelector('#edit-cliente').value = caseData.cliente || '';
                    form.querySelector('#edit-cpf').value = caseData.cpf || '';
                    form.querySelector('#edit-telefone').value = caseData.telefone || '';
                    form.querySelector('#edit-contrato').value = caseData.contrato || '';
                    form.querySelector('#edit-atrasoDesde').value = caseData.atrasoDesde || '';
                    form.querySelector('#edit-notificacao').value = caseData.notificacao || '';
                    
                    if (caseData.garantia) {
                        form.querySelector('#edit-placa').value = caseData.garantia.placa || '';
                        form.querySelector('#edit-marca').value = caseData.garantia.marca || '';
                        form.querySelector('#edit-modelo').value = caseData.garantia.modelo || '';
                        form.querySelector('#edit-ano').value = caseData.garantia.ano || '';
                        form.querySelector('#edit-cor').value = caseData.garantia.cor || '';
                        form.querySelector('#edit-renavam').value = caseData.garantia.renavam || '';
                        form.querySelector('#edit-chassi').value = caseData.garantia.chassi || '';
                        form.querySelector('#edit-valorFIPE').value = caseData.garantia.valorFIPE || '';
                    }
                    
                    App.ui.modals.editCase.classList.remove('hidden');
                },
                hideEditModal() {
                    App.ui.modals.editCase.classList.add('hidden');
                },
                async saveCaseChanges() {
                    const plate = App.state.currentPlate;
                    if (!plate) return;

                    const existingData = await App.DBManager.get(STORE_CASES, plate);
                    if (!existingData) return App.UIManager.showToast('Erro ao guardar: caso não encontrado.', 'error');

                    const form = App.ui.modals.editCaseForm;
                    const updatedData = {
                        ...existingData, // Preserve all existing data first
                        cliente: form.querySelector('#edit-cliente').value,
                        cpf: form.querySelector('#edit-cpf').value,
                        telefone: form.querySelector('#edit-telefone').value,
                        atrasoDesde: form.querySelector('#edit-atrasoDesde').value,
                        notificacao: form.querySelector('#edit-notificacao').value,
                        garantia: {
                            ...existingData.garantia,
                            marca: form.querySelector('#edit-marca').value,
                            modelo: form.querySelector('#edit-modelo').value,
                            ano: form.querySelector('#edit-ano').value,
                            cor: form.querySelector('#edit-cor').value,
                            renavam: form.querySelector('#edit-renavam').value,
                            chassi: form.querySelector('#edit-chassi').value,
                            valorFIPE: form.querySelector('#edit-valorFIPE').value
                        }
                    };

                    await App.DBManager.put(STORE_CASES, updatedData);
                    App.UIManager.showToast('Caso atualizado com sucesso!', 'success');
                    this.hideEditModal();
                    this.search(existingData.garantia.placa); // Refresh the view
                },
                async deleteSighting(id, p) { if (await App.UIManager.showConfirmation('Excluir Visita', 'Deseja excluir este registo?')) { await App.DBManager.delete(STORE_SIGHTINGS, id); App.UIManager.showToast('Visita excluída.', 'success'); this.search(p); } },
                async toggleCaseStatus(plate, switchElement) {
                    const caseData = await App.DBManager.get(STORE_CASES, plate);
                    if (!caseData) return;

                    const isClosing = switchElement.checked;
                    const newStatus = isClosing ? 'encerrado' : 'aberto';
                    const confirmationMessage = isClosing ? 'Deseja marcar este caso como encerrado?' : 'Deseja reabrir este caso?';

                    if (await App.UIManager.showConfirmation('Alterar Status do Caso', confirmationMessage)) {
                        caseData.status = newStatus;
                        caseData.dataEncerramento = isClosing ? new Date().toISOString() : null;
                        await App.DBManager.put(STORE_CASES, caseData);
                        App.UIManager.showToast(`Caso ${newStatus}!`, 'success');
                        this.search(caseData.garantia.placa); 
                    } else {
                        // Revert the switch if the user cancels
                        switchElement.checked = !isClosing;
                    }
                },
                async deleteCase(plate) {
                    if (await App.UIManager.showConfirmation('Excluir Caso?', 'Esta ação é PERMANENTE e apagará todos os dados associados (visitas, moradas, etc). Deseja continuar?')) {
                        if (await App.UIManager.showConfirmation('Confirmação Final', 'Última oportunidade. Tem a certeza que quer apagar este caso para sempre?')) {
                            App.UIManager.showLoading('A excluir caso...');
                            await Promise.all([ App.DBManager.delete(STORE_CASES, plate), ... (await App.DBManager.getFromIndex(STORE_SIGHTINGS, 'placaNormalizada', plate)).map(s => App.DBManager.delete(STORE_SIGHTINGS, s.id)), ... (await App.DBManager.getFromIndex(STORE_ADDRESSES, 'placaNormalizada', plate)).map(a => App.DBManager.delete(STORE_ADDRESSES, a.id)), ... (await App.DBManager.getFromIndex(STORE_OBSERVATIONS, 'placaNormalizada', plate)).map(o => App.DBManager.delete(STORE_OBSERVATIONS, o.id)) ]);
                            App.UIManager.hideLoading(); App.UIManager.showToast('Caso excluído com sucesso.', 'success');
                            App.ui.caseResult.innerHTML = ''; this.renderList();
                        }
                    }
                },
                async renderList() { 
                    App.UIManager.showLoading('A carregar...');
                    const allCases = await App.DBManager.getAll(STORE_CASES);
                    const uq = {m:new Set(), a:new Set(), c:new Set()};
                    allCases.forEach(c=>{if(c.garantia?.marca)uq.m.add(c.garantia.marca);if(c.garantia?.ano)uq.a.add(c.garantia.ano);if(c.garantia?.cor)uq.c.add(c.garantia.cor)});
                    
                    const createSelect = (id, lbl, opts, selectedVal) => `<div><label for="${id}" class="block text-sm font-medium mb-1">${lbl}</label><select id="${id}" class="filter-select mt-1 block w-full border rounded-md py-2 px-3 focus:outline-none" style="background-color:var(--input-bg); border-color:var(--border-color);"><option value="">Todas</option>${opts.map(o => `<option ${o === selectedVal ? 'selected' : ''}>${o}</option>`).join('')}</select></div>`;
                    const statusSelect = `<div><label for="filter-status" class="block text-sm font-medium mb-1">Status</label><select id="filter-status" class="filter-select mt-1 block w-full border rounded-md py-2 px-3 focus:outline-none" style="background-color:var(--input-bg); border-color:var(--border-color);"><option value="aberto" ${App.state.filterState.status === 'aberto' ? 'selected' : ''}>Abertos</option><option value="encerrado" ${App.state.filterState.status === 'encerrado' ? 'selected' : ''}>Encerrados</option><option value="todos" ${App.state.filterState.status === 'todos' ? 'selected' : ''}>Todos</option></select></div>`;
                    const sortSelect = `<div class="lg:col-start-5"><label for="sort-order" class="block text-sm font-medium mb-1">Ordenar por</label><select id="sort-order" class="filter-select mt-1 block w-full border rounded-md py-2 px-3 focus:outline-none" style="background-color:var(--input-bg); border-color:var(--border-color);"><option value="placa" ${App.state.filterState.sort === 'placa' ? 'selected' : ''}>Matrícula</option><option value="fipe-desc" ${App.state.filterState.sort === 'fipe-desc' ? 'selected' : ''}>Maior Valor FIPE</option><option value="fipe-asc" ${App.state.filterState.sort === 'fipe-asc' ? 'selected' : ''}>Menor Valor FIPE</option></select></div>`;

                    App.ui.filtersContainer.innerHTML = statusSelect 
                        + createSelect('filter-marca','Marca',[...uq.m].sort(), App.state.filterState.marca)
                        + createSelect('filter-ano','Ano',[...uq.a].sort((a,b)=>b.localeCompare(a)), App.state.filterState.ano)
                        + createSelect('filter-cor','Cor',[...uq.c].sort(), App.state.filterState.cor)
                        + sortSelect;
                    
                    App.ui.filterModelo.value = App.state.filterState.modelo;

                    const applyFiltersCallback = () => { App.state.currentPage = 1; this.applyFilters(allCases); };
                    document.querySelectorAll('.filter-select').forEach(sel=>sel.onchange = applyFiltersCallback);
                    App.ui.filterModelo.onkeyup = applyFiltersCallback;
                    App.ui.resetFiltersBtn.onclick = () => {
                        App.state.filterState = { status: 'aberto', marca: '', ano: '', cor: '', modelo: '', sort: 'placa' };
                        this.renderList();
                    };

                    this.applyFilters(allCases);
                    App.UIManager.hideLoading();
                },
                applyFilters(allCases) {
                    const getEl = id => document.getElementById(id);
                    App.state.filterState = {
                        status: getEl('filter-status')?.value || 'aberto',
                        marca: getEl('filter-marca')?.value || '',
                        ano: getEl('filter-ano')?.value || '',
                        cor: getEl('filter-cor')?.value || '',
                        modelo: App.ui.filterModelo.value.toUpperCase(),
                        sort: getEl('sort-order')?.value || 'placa',
                    };

                    let filtered = allCases.filter(c => {
                        const statusMatch = App.state.filterState.status === 'todos' || (c.status || 'aberto') === App.state.filterState.status;
                        const modelMatch = (c.garantia?.modelo || '').toUpperCase().includes(App.state.filterState.modelo);
                        return statusMatch && modelMatch && (!App.state.filterState.marca || c.garantia.marca === App.state.filterState.marca) && (!App.state.filterState.ano || c.garantia.ano === App.state.filterState.ano) && (!App.state.filterState.cor || c.garantia.cor === App.state.filterState.cor);
                    });
                    
                    const parseFipe = (val) => parseFloat((val || '0').replace(/[^0-9,]/g, '').replace(',', '.'));
                    filtered.sort((a, b) => {
                        if (App.state.filterState.sort === 'fipe-asc') return parseFipe(a.garantia?.valorFIPE) - parseFipe(b.garantia?.valorFIPE);
                        if (App.state.filterState.sort === 'fipe-desc') return parseFipe(b.garantia?.valorFIPE) - parseFipe(a.garantia?.valorFIPE);
                        return (a.garantia?.placa || '').localeCompare(b.garantia?.placa || '');
                    });

                    this.displayFilteredCases(filtered);
                },
                displayFilteredCases(filteredCases) {
                    const end = App.state.currentPage * App.config.resultsPerPage;
                    if(App.state.currentPage === 1) App.ui.caseList.innerHTML = '';
                    if(filteredCases.length === 0 && App.state.currentPage === 1) return App.ui.caseList.innerHTML = `<div class="p-4 rounded-lg text-center" style="background-color: var(--card-color);">Nenhum caso encontrado.</div>`;
                    
                    filteredCases.slice((App.state.currentPage-1) * App.config.resultsPerPage, end).forEach(c=>{
                        const card = document.createElement('div');
                        card.className = 'case-card p-4 rounded-lg shadow-md';
                        card.style.backgroundColor = 'var(--card-color)';
                        card.dataset.plate = c.placaNormalizada;
                        card.dataset.plateValue = c.garantia.placa;
                        
                        const statusIndicator = (c.status === 'encerrado') ? `<span class="text-xs font-bold text-yellow-400 bg-yellow-900/50 px-2 py-1 rounded-full">Encerrado</span>` : '';
                        
                        card.innerHTML = `<div class="flex justify-between items-center gap-4"><div class="case-card-main flex-grow cursor-pointer"><div class="flex items-center gap-2"><h3 class="text-xl font-bold" style="color:var(--primary-color);">${c.garantia.marca} ${c.garantia.modelo}</h3>${statusIndicator}</div><p class="text-md" style="color:var(--text-muted-color);">Contrato: ${c.contrato || 'N/A'}<br>Matrícula: <strong>${c.garantia.placa}</strong> | Cor: ${c.garantia.cor}</p></div></div>`;
                        App.ui.caseList.appendChild(card);
                    });
                    App.ui.loadMoreBtn.classList.toggle('hidden', end >= filteredCases.length);
                },
                loadMore() { App.state.currentPage++; App.DBManager.getAll(STORE_CASES).then(a=>this.applyFilters(a)); }
            };
            
            // =================================================================================
            // DATA MANAGER (Parse, Import, Export, Backup)
            // =================================================================================
            App.DataManager = {
                parse(text) {
                    const getFieldValue = (keyword) => {
                         const lines = text.split('\n');
                         const keywordIndex = lines.findIndex(l => l.toUpperCase().trim().startsWith(keyword.toUpperCase()));
                         if (keywordIndex > -1 && lines[keywordIndex + 1]) {
                             let value = lines[keywordIndex + 1].trim();
                             if (keyword.toUpperCase() === 'CLIENTE') {
                                 value = value.replace(/^[\d\s-]*\s?/, '');
                             }
                             return value;
                         }
                         const singleLineRegex = new RegExp(`${keyword}(\\s*|:)\\s*(.+)`, 'i');
                         const match = text.match(singleLineRegex);
                         if (match && match.length > 2) return match[2].trim();

                         return null;
                    };
                    
                    const getSpecificNextLineValue = (keyword, precedingKeyword, data = text) => {
                         const lines = data.split('\n');
                         let precedingFound = false;
                         for(let i=0; i<lines.length; i++) {
                             if(lines[i].toUpperCase().trim().startsWith(precedingKeyword.toUpperCase())) {
                                 precedingFound = true;
                             }
                             if(precedingFound && lines[i].toUpperCase().trim().startsWith(keyword.toUpperCase()) && lines[i+1]) {
                                 return lines[i+1].trim().replace(/^[\d\s-]*\s?/, '');
                             }
                         }
                         return null;
                    };

                    const data = { garantia: {} };
                    
                    data.contrato = text.match(/Info\. Contrato:\s*(\S+)/i)?.[1] || null;
                    data.cliente = getSpecificNextLineValue('Cliente', 'Informações', text);
                    data.cpf = getFieldValue('CPF/CNPJ');
                    data.telefone = getFieldValue('Telefone Preferencial');
                    
                    data.atrasoDesde = text.match(/desde\s*(\d{2}\/\d{2}\/\d{4})/i)?.[1] || null;
                    data.notificacao = getFieldValue('Notificação');
                    
                    data.garantia.marcaModelo = getFieldValue('Marca/Modelo');
                    data.garantia.ano = getFieldValue('Ano');
                    data.garantia.placa = getFieldValue('Placa');
                    data.garantia.renavam = getFieldValue('Renavam');
                    data.garantia.chassi = getFieldValue('Chassi');
                    data.garantia.cor = getFieldValue('Cor');
                    data.garantia.valorFIPE = getFieldValue('Valor');

                    if (data.garantia.marcaModelo) { const [marca, ...modelo] = data.garantia.marcaModelo.split('/'); data.garantia.marca = marca?.trim(); data.garantia.modelo = modelo.join('/')?.trim(); delete data.garantia.marcaModelo; }
                    data.placaNormalizada = App.PlateManager.normalize(data.garantia.placa);
                    data.status = 'aberto';
                    
                    if (!data.placaNormalizada || !data.contrato) return null;
                    return data;
                },
                _mergeCaseData(existing, newData) { const merged = JSON.parse(JSON.stringify(existing)); for (const key in newData) { if (key !== 'garantia' && newData[key]) merged[key] = newData[key]; } if (newData.garantia) { if (!merged.garantia) merged.garantia = {}; for (const key in newData.garantia) { if (newData.garantia[key]) merged.garantia[key] = newData.garantia[key]; } } return merged; },
                async saveParsedData(){
                    const text = App.ui.settings.dataInput.value; if(!text) return App.UIManager.showToast('Caixa de texto vazia.','error');
                    App.UIManager.showLoading('A analisar...');
                    try {
                        const parsedData = this.parse(text); if (!parsedData) throw new Error('Dados essenciais (matrícula, contrato) não encontrados no texto.');
                        const existingCase = await App.DBManager.get(STORE_CASES, parsedData.placaNormalizada);
                        if (existingCase) {
                            const updatedCase = this._mergeCaseData(existingCase, parsedData);
                            await App.DBManager.put(STORE_CASES, updatedCase);
                            App.UIManager.showToast(`Caso ${parsedData.garantia.placa} atualizado!`, 'success');
                        } else {
                            await App.DBManager.put(STORE_CASES, parsedData);
                            App.UIManager.showToast(`Novo caso para matrícula ${parsedData.garantia.placa} guardado!`, 'success');
                        }
                        App.UIManager.hideLoading(); App.ui.settings.dataInput.value = '';
                    } catch(e) { App.UIManager.hideLoading(); App.UIManager.showToast(`Erro: ${e.message}`, 'error'); }
                },
                async backup() {
                    App.UIManager.showLoading('A preparar backup...');
                    try {
                        const [cases, sightings, addresses, observations, logs] = await Promise.all([App.DBManager.getAll(STORE_CASES), App.DBManager.getAll(STORE_SIGHTINGS), App.DBManager.getAll(STORE_ADDRESSES), App.DBManager.getAll(STORE_OBSERVATIONS), App.DBManager.getAll(STORE_LOGS)]);
                        const picaInstance = pica();
                        const blobToBase64 = blob => new Promise(resolve => { const reader = new FileReader(); reader.readAsDataURL(blob); reader.onloadend = () => resolve(reader.result); });
                        for (const s of sightings) {
                            if (s.photo) { 
                                const img = await createImageBitmap(s.photo); 
                                const canvas = document.createElement('canvas'); 
                                const resized = await picaInstance.resize(img, canvas); 
                                s.photoBase64 = await blobToBase64(await picaInstance.toBlob(resized, 'image/jpeg', 0.7)); 
                                delete s.photo; 
                            }
                        }
                        const dataBlob = new Blob([JSON.stringify({ version: 3, timestamp: new Date(), data: { cases, sightings, addresses, observations, logs } })], {type: 'application/json'});
                        const link = document.createElement('a'); link.href = URL.createObjectURL(dataBlob); link.download = `backup_localizador_${new Date().toISOString().slice(0,10)}.json`; link.click(); URL.revokeObjectURL(link.href);
                        App.UIManager.hideLoading(); App.UIManager.showToast('Backup criado!', 'success');
                    } catch (e) { App.UIManager.hideLoading(); App.UIManager.showToast(`Falha no backup: ${e.message}`, 'error'); }
                },
                restore() { App.ui.settings.restoreFileInput.click(); },
                async handleRestoreFile(file){
                    if(!file) return;
                    const strategy = await App.UIManager.showRestoreStrategyModal();
                    if(!strategy) return;
                    
                    App.UIManager.showLoading('A restaurar...');
                    try {
                        const backupText = await file.text();
                        const backupData = JSON.parse(backupText);
                        if (!backupData.data) throw new Error("Formato de backup inválido.");

                        if (strategy === 'overwrite') { 
                            const storesToClear = [STORE_CASES, STORE_SIGHTINGS, STORE_ADDRESSES, STORE_OBSERVATIONS, STORE_LOGS, STORE_BACKUPS];
                            await App.DBManager.transaction(storesToClear, 'readwrite', stores => stores.forEach(s => s.clear()));
                        }
                        if(backupData.data.cases) for(const item of backupData.data.cases) await App.DBManager.put(STORE_CASES, item);
                        if(backupData.data.sightings) for(const item of backupData.data.sightings){ if(item.photoBase64) item.photo = await(await fetch(item.photoBase64)).blob(); delete item.photoBase64; await App.DBManager.put(STORE_SIGHTINGS, item); }
                        if(backupData.data.addresses) for(const item of backupData.data.addresses) await App.DBManager.put(STORE_ADDRESSES, item);
                        if(backupData.data.observations) for(const item of backupData.data.observations) await App.DBManager.put(STORE_OBSERVATIONS, item);
                        if(backupData.data.logs) for(const item of backupData.data.logs) await App.DBManager.put(STORE_LOGS, item);
                        
                        await App.DBManager.put(STORE_LOGS, { message: `Backup de ${new Date(backupData.timestamp).toLocaleString()} restaurado com modo ${strategy}.`, timestamp: new Date() });

                        App.UIManager.hideLoading(); App.UIManager.showToast('Restauro concluído!','success');
                        if(document.getElementById('tab-list').classList.contains('active')) App.CaseManager.renderList();
                    } catch (e) { App.UIManager.hideLoading(); App.UIManager.showToast(`Erro ao restaurar: ${e.message}`, 'error'); }
                },
                _addPdfHeader(doc, titleText) {
                    doc.setFontSize(18);
                    const titleWidth = doc.getStringUnitWidth(titleText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                    const docWidth = doc.internal.pageSize.getWidth();
                    doc.text(titleText, (docWidth - titleWidth) / 2, 22);
                },
                _addPdfFooter(doc, filters) {
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    for(var i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        const footerText = `Lista de Casos (${filters.status.toUpperCase()}) - Gerado em: ${new Date().toLocaleDateString('pt-BR')}`;
                        const pageWidth = doc.internal.pageSize.getWidth();
                        doc.text(footerText, pageWidth - 14, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                    }
                },
                _addPdfSection(doc, title, body, startY) { if(body.length > 0){ doc.autoTable({ head: [[title, '']], body, startY, theme: 'grid' }); return doc.lastAutoTable.finalY + 10; } return startY; },
                
                async _addPdfImages(doc, sightings, startY) {
                    const images = sightings.filter(s => s.photo);
                    if (images.length === 0) return startY;
                
                    let currentY = startY;
                    if (currentY > 180) { 
                        doc.addPage();
                        currentY = 20;
                    }

                    doc.autoTable({ head: [['Visitas e Avistamentos (Imagens)']], startY: currentY });
                    currentY = doc.lastAutoTable.finalY + 5;
                
                    const picaInstance = pica();
                    const imgWidth = 45; 
                    const imgMargin = 5;
                    let x = 14;
                    let rowMaxHeight = 0;
                    let imgHeight = 0; // Declare imgHeight here
                
                    for (const s of images) {
                        const offscreenCanvas = document.createElement('canvas');
                        const img = await createImageBitmap(s.photo);
                        const resizedCanvas = await picaInstance.resize(img, offscreenCanvas);
                        const dataUrl = resizedCanvas.toDataURL('image/jpeg', 0.7);
                        imgHeight = (img.height / img.width) * imgWidth; // Assign value inside the loop
                        rowMaxHeight = Math.max(rowMaxHeight, imgHeight);
                
                        if (x + imgWidth > doc.internal.pageSize.width - 14) {
                            x = 14;
                            currentY += rowMaxHeight + 15;
                            rowMaxHeight = 0;
                        }
                        if (currentY + imgHeight > doc.internal.pageSize.height - 20) {
                            doc.addPage();
                            currentY = 20;
                            x = 14;
                        }
                        doc.addImage(dataUrl, 'JPEG', x, currentY, imgWidth, imgHeight);
                        doc.setFontSize(8);
                        doc.text(new Date(s.timestamp).toLocaleDateString('pt-BR'), x, currentY + imgHeight + 5);
                        x += imgWidth + imgMargin;
                    }
                    return currentY + rowMaxHeight + 15;
                },

                async _generateSingleCasePdf(doc, caseData) {
                    const [sightings, addresses, observations] = await Promise.all([ App.DBManager.getFromIndex(STORE_SIGHTINGS, 'placaNormalizada', caseData.placaNormalizada), App.DBManager.getFromIndex(STORE_ADDRESSES, 'placaNormalizada', caseData.placaNormalizada), App.DBManager.getFromIndex(STORE_OBSERVATIONS, 'placaNormalizada', caseData.placaNormalizada) ]);
                    
                    let lastY = this._addPdfHeader(doc, `Relatório do Caso: ${caseData.garantia.placa}`);
                    const caseDetails = [
                        ['Cliente', caseData.cliente], ['CPF', caseData.cpf], ['Telefone', caseData.telefone],
                        ['Contrato', caseData.contrato], ['Atraso Desde', caseData.atrasoDesde],
                    ];
                    lastY = this._addPdfSection(doc, 'Informações do Contrato', caseDetails.filter(d => d[1]), lastY);
                    
                    const warrantyDetails = Object.entries(caseData.garantia).map(([k, v]) => [k.charAt(0).toUpperCase() + k.slice(1), v]);
                    lastY = this._addPdfSection(doc, 'Dados da Garantia', warrantyDetails.filter(d => d[1]), lastY);
                    
                    lastY = await this._addPdfImages(doc, sightings, lastY);
                    return doc;
                },
                async exportSingleCasePDF(plate) {
                    App.UIManager.showLoading('A gerar PDF do Caso...');
                    try {
                        const caseData = await App.DBManager.get(STORE_CASES, plate);
                        if (!caseData) throw new Error('Caso não encontrado.');
                        const doc = new window.jspdf.jsPDF();
                        await this._generateSingleCasePdf(doc, caseData);
                        doc.save(`relatorio_${caseData.garantia.placa}.pdf`);
                    } catch(e) {
                        App.UIManager.showToast(e.message, 'error');
                    } finally {
                        App.UIManager.hideLoading();
                    }
                },
                async exportAllToPDF() {
                    App.UIManager.showLoading('A gerar PDF Completo...');
                    try {
                        const { jsPDF } = window.jspdf;
                        const mainDoc = new jsPDF();
                        const cases = await App.DBManager.getAll(STORE_CASES);
                        if (cases.length === 0) throw new Error('Nenhum caso para exportar.');

                        for (const [index, caseData] of cases.entries()) {
                             if (index > 0) mainDoc.addPage();
                            App.UIManager.showLoading(`A processar PDF ${index + 1} de ${cases.length}...`);
                            await this._generateSingleCasePdf(mainDoc, caseData);
                        }
                        mainDoc.save(`relatorio_completo_${new Date().toISOString().slice(0, 10)}.pdf`);
                    } catch(e) {
                         App.UIManager.showToast(e.message, 'error');
                    } finally {
                        App.UIManager.hideLoading();
                    }
                },
                 async exportListPDF() {
                    App.UIManager.showLoading('A gerar Lista em PDF...');
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const allCases = await App.DBManager.getAll(STORE_CASES);
                    const filters = {
                        status: document.getElementById('filter-status')?.value || 'aberto',
                        marca: document.getElementById('filter-marca')?.value,
                        ano: document.getElementById('filter-ano')?.value,
                        cor: document.getElementById('filter-cor')?.value,
                        modelo: document.getElementById('filter-modelo')?.value.toUpperCase() || ''
                    };
                    const filteredCases = allCases.filter(c => {
                        const statusMatch = filters.status === 'todos' || (c.status || 'aberto') === filters.status;
                        const modelMatch = (c.garantia?.modelo || '').toUpperCase().includes(filters.modelo);
                        return statusMatch && modelMatch && (!filters.marca || c.garantia.marca === filters.marca) && (!filters.ano || c.garantia.ano === filters.ano) && (!filters.cor || c.garantia.cor === filters.cor);
                    });

                    if(filteredCases.length === 0) { App.UIManager.hideLoading(); return App.UIManager.showToast('Nenhum caso para exportar.', 'error'); }
                    
                    const body = filteredCases.map(c => ([
                        c.contrato || 'N/A',
                        `${c.garantia.marca} ${c.garantia.modelo}`,
                        c.garantia.placa,
                        c.garantia.cor,
                        c.garantia.valorFIPE?.match(/R\$\s*[\d,.]+/)?.[0] || 'N/A'
                    ]));

                    doc.autoTable({
                        head: [['Contrato', 'Veículo', 'Placa', 'Cor', 'Valor FIPE']],
                        body,
                        didDrawPage: (data) => {
                            this._addPdfHeader(doc, `Lista de Casos (${filters.status.toUpperCase()})`);
                        },
                        margin: { top: 35 },
                        styles: { fontSize: 10, cellPadding: 2, overflow: 'ellipsize' },
                        headStyles: { fontSize: 11, fillColor: [41, 128, 185], halign: 'center' },
                        columnStyles: {
                           0: { halign: 'center', cellWidth: 35 }, 
                           1: { halign: 'left', cellWidth: 'auto' }, 
                           2: { halign: 'center', cellWidth: 25 }, 
                           3: { halign: 'center', cellWidth: 20 },
                           4: { halign: 'left', cellWidth: 30 }, 
                        }
                    });
                    
                    this._addPdfFooter(doc, filters);

                    doc.save(`lista_casos_${new Date().toISOString().slice(0, 10)}.pdf`);
                    App.UIManager.hideLoading();
                },
                async exportCSV() {
                    App.UIManager.showLoading('A gerar CSV...');
                    const sightings = await App.DBManager.getAll(STORE_SIGHTINGS);
                    if (sightings.length === 0) { App.UIManager.hideLoading(); return App.UIManager.showToast('Nenhuma visita para exportar.', 'error'); }
                    const cases = await App.DBManager.getAll(STORE_CASES);
                    const caseMap = new Map(cases.map(c => [c.placaNormalizada, c]));
                    const headers = ['Data Visita','Lat Visita','Lon Visita','Matrícula','Marca','Modelo','Ano','Cor','Cliente','CPF','Contrato', 'Status'];
                    let csvRows = [headers.join(',')];
                    for (const s of sightings) {
                        const c = caseMap.get(s.placaNormalizada);
                        if (!c) continue;
                        const row = [ `"${new Date(s.timestamp).toLocaleString('pt-BR')}"`, s.location ? s.location.lat : '', s.location ? s.location.lon : '', c.garantia.placa, c.garantia.marca, c.garantia.modelo, c.garantia.ano, c.garantia.cor, `"${c.cliente}"`, `"${c.cpf}"`, `"${c.contrato}"`, c.status || 'aberto' ];
                        csvRows.push(row.join(','));
                    }
                    const blob = new Blob([csvRows.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `relatorio_visitas_${new Date().toISOString().slice(0, 10)}.csv`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    App.UIManager.hideLoading();
                },
            };

            // =================================================================================
            // EVENT LISTENERS AND APP START
            // =================================================================================
            document.addEventListener('DOMContentLoaded', async () => {
                App.ThemeManager.init();
                App.UIManager.init();
                App.UIManager.showLoading('A inicializar...');
                try {
                    await App.DBManager.open();
                    App.CaseManager.renderList();
                    App.PermissionsManager.requestInitialPermissions();
                    App.UIManager.hideLoading();
                    App.UIManager.showToast('Pronto para utilização!', 'success');
                } catch (e) {
                    App.UIManager.hideLoading();
                    App.UIManager.showToast(`Falha na inicialização: ${e.message}`, 'error');
                }
                
                App.ui.settings.resetAppBtn.onclick = () => {
                    const modal = App.ui.modals.resetConfirm;
                    const input = App.ui.modals.resetConfirmInput;
                    const okBtn = App.ui.modals.resetConfirmOkBtn;
                    
                    input.value = '';
                    okBtn.disabled = true;
                    modal.classList.remove('hidden');

                    input.oninput = () => {
                        okBtn.disabled = input.value.toUpperCase() !== 'CONFIRMO';
                    };

                    App.ui.modals.resetCancelBtn.onclick = () => modal.classList.add('hidden');
                    okBtn.onclick = async () => {
                        modal.classList.add('hidden');
                        App.UIManager.showLoading('A limpar todos os dados...');
                        const stores = [STORE_CASES, STORE_SIGHTINGS, STORE_ADDRESSES, STORE_OBSERVATIONS, STORE_LOGS, STORE_BACKUPS];
                        await App.DBManager.transaction(stores, 'readwrite', (s) => s.forEach(store => store.clear()));
                        localStorage.clear();
                        App.UIManager.showToast('Aplicação redefinida. A recarregar...', 'success');
                        setTimeout(() => location.reload(), 2000);
                    };
                };

                App.ui.searchPlateBtn.onclick = () => App.CaseManager.search(App.ui.plateInput.value);
                App.ui.plateInput.onkeypress = (e) => { if (e.key === 'Enter') App.CaseManager.search(App.ui.plateInput.value); };
                App.ui.settings.parseAndSaveBtn.onclick = () => App.DataManager.saveParsedData();
                App.ui.settings.backupBtn.onclick = () => App.DataManager.backup();
                App.ui.settings.restoreBtn.onclick = () => App.DataManager.restore();
                App.ui.settings.restoreFileInput.onchange = e => { App.DataManager.handleRestoreFile(e.target.files[0]); e.target.value = ''; };
                App.ui.settings.exportPdfBtn.onclick = () => App.DataManager.exportAllToPDF();
                App.ui.settings.exportCsvBtn.onclick = () => App.DataManager.exportCSV();
                App.ui.settings.exportListPdfBtn.onclick = () => App.DataManager.exportListPDF();
                App.ui.settings.showLogsBtn.onclick = async () => { 
                    const logs = await App.DBManager.getAll(STORE_LOGS);
                    App.ui.modals.logsContent.innerHTML = logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(log => `<div class="p-2 text-sm" style="border-bottom: 1px solid var(--border-color);"><span class="font-semibold" style="color:var(--primary-color);">${new Date(log.timestamp).toLocaleString('pt-BR')}</span>: <span>${log.message}</span></div>`).join('');
                    App.ui.modals.logs.classList.remove('hidden'); 
                };
                App.ui.modals.closeLogsBtn.onclick = () => App.ui.modals.logs.classList.add('hidden');
                App.ui.modals.closeCameraBtn.onclick = () => App.UIManager.hideCamera();
                App.ui.modals.capturePhotoBtn.onclick = () => App.UIManager.capturePhoto();
                App.ui.loadMoreBtn.onclick = () => App.CaseManager.loadMore();
                App.ui.modals.closePhotoViewBtn.onclick = () => App.UIManager.hidePhoto();
                App.ui.modals.editCaseSaveBtn.onclick = () => App.CaseManager.saveCaseChanges();
                App.ui.modals.editCaseCancelBtn.onclick = () => App.CaseManager.hideEditModal();
                App.ui.modals.addressParseAndSaveBtn.onclick = () => App.AddressManager.handleParseAndSave();
                App.ui.modals.addressPreviewConfirmBtn.onclick = () => App.AddressManager.confirmAndSaveAddresses();
                App.ui.modals.addressPreviewCancelBtn.onclick = () => App.AddressManager.hideAddressPreview();
                App.ui.modals.useCurrentLocationBtn.onclick = () => App.AddressManager.saveFromGPS();
                App.ui.modals.addressCancelBtn.onclick = () => App.AddressManager.hideAddressModal();
                App.ui.modals.observationSaveBtn.onclick = () => App.ObservationManager.saveObservation();
                App.ui.modals.observationCancelBtn.onclick = () => App.ObservationManager.hideObservationModal();
                App.ui.modals.takePictureBtn.onclick = async () => { 
                    App.UIManager.hideImageSourceModal(); 
                    if (await App.PermissionsManager.requestCamera()) {
                        App.UIManager.showCamera(); 
                    }
                };
                App.ui.modals.chooseGalleryBtn.onclick = () => { 
                    App.UIManager.hideImageSourceModal(); 
                    App.ui.imageUploadInput.click(); 
                };
                App.ui.modals.imageSourceCancelBtn.onclick = () => App.UIManager.hideImageSourceModal();
                App.ui.imageUploadInput.onchange = e => { if(e.target.files[0]) { App.UIManager._saveSighting(e.target.files[0]); e.target.value = ''; } };
            });
        })();
    </script>
</body>
</html>
